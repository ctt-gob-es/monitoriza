<div class="modal" tabindex="-1" role="dialog" id="summaryModal"
	name="summaryModal">
	<div class="modal-dialog">
		<div class="modal-content" style="margin-left: -50%; width: 200%;">
			<div class="modal-header">
				<h4 class="modal-title"
					th:text="#{applalert.summaries.modal.add.title}"></h4>
				<button type="button" class="close" data-dismiss="modal"
					aria-label="Cerrar">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<form name="altEditor-form" role="form" id="summaryForm" th:object="${summaryform}" th:action="@{/saveresume}" method="post">
				<div class="modal-body">
					<div class="row gap-30 masonry pos-r">
						<div class="masonry-sizer col-md-12"></div>
						<div class="masonry-item col-md-6">
							<div class="bgc-white p-20 bd">
								<div>
									<input type='hidden' class='primarykey' id="idResumeMonitoriza"
										th:field="*{idResumeMonitoriza}">

									<div class="form-row">
										<div class="form-group col-md-12">
											<label for="name" th:text="#{applalert.summaries.modal.name}"></label>
											<input type="text" th:field="*{name}" class="form-control" id="name" >
										</div>
									</div>
									<div class="form-row">
										<div
											class="checkbox checkbox-circle checkbox-info peers mL-5 mB-20 mT-10">
											<input type="checkbox" id="enabled" name="enabled" class="peer" th:checked="${summaryform.enabled}"> 
												<label for="enabled" class="peers peer-greed js-sb ai-c"> 
												<span class="peer peer-greed" th:text="#{applalert.summaries.modal.activeresume}">
												</span>
											</label>
										</div>
									</div>
									<div class="form-row">
										<div class="form-group col-md-12">
											<label for="description"
												th:text="#{applalert.summaries.modal.description}"></label>
											<input type="text" class="form-control" id="description" th:field="*{description}"
												name="description">
										</div>
									</div>
									<div class="form-row">
										<div class="form-group col-md-12">
											<label for="periodicity"
												th:text="#{applalert.summaries.modal.periodicity}"></label>
											<select id="periodicity" class="form-control"
												name="periodicity" th:field="*{periodicity}" required>
												<option selected="selected" value="1"
													th:text="#{applalert.summaries.modal.periodicity.select.hourly}"></option>
												<option value="24"
													th:text="#{applalert.summaries.modal.periodicity.select.daily}"></option>
												<option value="168"
													th:text="#{applalert.summaries.modal.periodicity.select.weekly}"></option>
												<option value="720"
													th:text="#{applalert.summaries.modal.periodicity.select.monthly}"></option>
											</select>
										</div>
									</div>
									<div class="form-row">
										<div class="form-group col-md-10">
											<label for="alertSystemsList" th:text="#{applalert.summaries.modal.notifsystem}"></label>
											<select name="alertSystemsList" id="alertSystemsList"
												class="form-control" th:field="*{alertSystemsList}" required>
												<option th:each="t: ${alertSystemsList}"
													th:value="${t.idAlertSystemMonitoriza}" th:text="${t.name}"></option>
											</select>
										</div>
										<div class="form-group col-md-2 align-self-end">
											<button id="btnAddAlertSystem"
												type="button"
												class="btn btn-primary"
												th:text="#{applalert.summaries.modal.btn.add}"></button>
										</div>
									</div>
									<table id="alertSystemTable"
										class="table table-striped table-bordered" cellspacing="0"
										width="100%">
										<thead>
											<tr>
												<!-- Columna oculta para el identificador de la plataforma -->
												<th></th>
												<th th:text="#{applalert.summaries.modal.notifsystem}"></th>
											</tr>
										</thead>
									</table>
								</div>
							</div>
						</div>

						<div class="masonry-item col-md-6">
							<div class="bgc-white p-20 bd">
								<h6 class="c-grey-900"
									th:text="#{applalert.summaries.modal.alertslist}"></h6>
								<div class="mT-30">
									<div class="form-row">
										<div class="form-group col-md-4">
											<label for="applicationsList"
												th:text="#{applalert.summaries.modal.table.application}"></label>
											<select name="applicationsList" id="applicationsList"
												class="form-control" th:field="*{applicationsList}" required>
												<option th:each="t: ${applicationsList}"
													th:value="${t.idApplicationMonitoriza}" th:text="${t.name}"></option>
											</select>
										</div>
										<div class="form-group col-md-2 align-self-end">
											<button id="btnAddAllAlerts" type="button"
												class="btn btn-primary"
												th:text="#{applalert.summaries.modal.btn.addall}"></button>
										</div>
										<div class="form-group col-md-3 mL-25">
											<label for="alertConfigList"
												th:text="#{applalert.summaries.modal.table.alert}"></label>
											<select name="alertConfigList" id="alertConfigList"
												class="form-control" th:field="*{alertConfigList}" required>
												<option th:each="t: ${alertConfigList}"
													th:value="${t.idAlertConfigMonitoriza}"
													th:text="${t.alertTypeMonitoriza.name}"></option>
											</select> </select>
										</div>
										<div class="form-group col-md-2 align-self-end">
											<button id="btnAddAlertConfig" type="button"
												class="btn btn-primary"
												th:text="#{applalert.summaries.modal.btn.add}"></button>
										</div>
									</div>
									<table id="alertListTable"
										class="table table-striped table-bordered" cellspacing="0"
										width="100%">
										<thead>
											<tr>
												<!-- Columna oculta para el identificador de la aplicacion-->
												<th></th>
												<th th:text="#{applalert.summaries.modal.table.application}"></th>
												<th></th>
												<th th:text="#{applalert.summaries.modal.table.alert}"></th>
											</tr>
										</thead>
									</table>
								</div>
							</div>
						</div>
					</div>
				</div>-
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal"
					th:text="#{button.close}"></button>
				<button type="button" id="summaryButton" class="btn btn-primary"
					th:text="#{applalert.summaries.modal.btn.accept}"></button>
			</div>
			</form>
		</div>
	</div>
</div>

<div class="modal" tabindex="-1" role="dialog" id="configureEmailsModal">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h4 class="modal-title"
					th:text="#{applalert.summaries.modal.emailconfiguration.title}"></h4>
				<button type="button" class="close" data-dismiss="modal"
					aria-label="Cerrar">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<div class="modal-body">
				<div class="form-row">
					<div class="form-group col-md-12">
						<label for="emails" th:text="#{applalert.summaries.modal.emailconfiguration.description}"></label>
						<textarea cols="10" rows="5" class="form-control mon-log-panel" id="emails"></textarea>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" th:text="#{button.close}"></button>
					<button type="button" id="confEmailButton" class="btn btn-primary" 
					th:text="#{applalert.summaries.modal.btn.config}"></button>
				</div>
			</div>
		</div>
	</div>
</div>

<script th:inline="javascript">

	var alertSystemCounter = 0;
	var appAlertConfigCounter = 0;
	var alertSystemIdListIndex = 0;
	var alertConfigIdListIndex = 0;

	//Relacion aplicacion - alerta???

	$(document).ready(function () {

		var getAlertsFromApp = /*[[@{/alertsfromapplication}]]*/;
		var saveResume = /*[[@{/saveresume}]]*/;

		var alertSystemTbl = $('#alertSystemTable').DataTable({
			dom: 'Bfrtip',
		    responsive: true,
			select: 'single',
			searching: false,
			altEditor: true,
			"bLengthChange" : false,
		    buttons: [
				{extend: 'selected',text: 'Configurar',name: 'configure',
					action: function ( e, dt, node, config ) {
						$('#configureEmailsModal').modal('show');
	  			  }},   
    			{extend: 'selected',text: 'Eliminar',name: 'delete'}
			],
		    "language": {
		        "url": "js/datatables/i18n/spanish.json",
		        select: {
		            rows: {
		                _: "%d filas seleccionadas",
		                1: "1 fila seleccionada"
		            }
		          }
		    },
			"columns": [
				{ "data": "idAlertSystemMonitoriza", "visible": false},
		        { "data": "name" }
		        ]
			});

		var alertConfigTbl = $('#alertListTable').DataTable({
			dom: 'Bfrtip',
		    responsive: true,
			select: 'single',
			searching: false,
			altEditor: true,
			"bLengthChange" : false,
		    buttons: [
				{extend: 'selected',text: 'Eliminar',name: 'delete'}
			],
		    "language": {
		        "url": "js/datatables/i18n/spanish.json",
		        select: {
		            rows: {
		                _: "%d filas seleccionadas",
		                1: "1 fila seleccionada"
		            }
		          }
		    },
			"columns": [
				{ "data": "idApplicationMonitoriza", "visible": false},
		        { "data": "appName" },
		        { "data": "idAlertConfigMonitoriza", "visible": false},
		        { "data": "alertConfigName" }
		        ]
			});
	
    	$("#applicationsList").change(function () {
        	
        	var idApplicationMonitoriza = $("#applicationsList option:selected").val();

    		$.ajax(getAlertsFromApp, {
                data : $.param({'id':idApplicationMonitoriza}),
                type:'POST',
                success: function(data){
                    if (data) {  
                        $('#alertConfigList').html('');  
                        var options = '';
                        for (var i = 0; i < data.length; i++) {  
                            options += '<option value="' + data[i].idAlertConfigMonitoriza + '">' + data[i].alertTypeMonitoriza.name + '</option>';  
                        }  
                        $('#alertConfigList').append(options);  
                    }
                },
                error:function(data){
                	console.log(data);
                }
            });
     	
    	});	

        $('#btnAddAlertSystem').on( 'click', function () {
            var alertSystemJsonText = '{"0":' + 
            '{"idAlertSystemMonitoriza":' + $("#alertSystemsList option:selected").val() + 
            ',"name":"' + $("#alertSystemsList option:selected").text() + '"}, "length":1}';
            var data = JSON.parse(alertSystemJsonText);
        	alertSystemTbl.row.add($(data)).draw(false);
        });

        $('#btnAddAlertConfig').on( 'click', function () {
     	   insertAlertConfig($("#applicationsList option:selected").val(),
								$("#applicationsList option:selected").text(),
								$("#alertConfigList option:selected").val(),
								$("#alertConfigList option:selected").text());
        });

        $("#btnAddAllAlerts").click(function(){
            $("#alertConfigList option").each(function(){
               if ($(this).val() != "" ){
            	   insertAlertConfig($("#applicationsList option:selected").val(), 
                    	   			$("#applicationsList option:selected").text(),
            			   			$(this).val(), 
            			   			$(this).text());
               }
            });
          });

        $("#summaryButton").click(function(){
        	
            loading();
			$.ajax(saveResume, {
            	dataType : 'json',
            	contentType:'application/json',
                data : JSON.stringify($("#summaryForm").serializeJSON()),
                type:'POST',
                success: function(data){
            		// Se oculta la capa 'cargando...'
            		hide();
            		alert('conseguido' + data);
  				  	tbl.row.add($(data.data)).draw(false);
                    
                    $('#altEditor-modal .modal-body .alert').remove();
                    $('#altEditor-modal').modal('hide');
                },
                error:function(data){
                	hide();
                	alert('error' + data.error);
                	$('#errorModalSummary').remove();
                	$('#summaryForm').append('<div id="errorModalSummary" class="alert alert-danger" role="alert"><strong>ERROR</strong></div>');
                }
            });
		});

        function insertAlertConfig(appValue, appText, alertValue, alertText){
			var alertConfigJsonText = '{"0":' + 
            '{"idApplicationMonitoriza":' + appValue + 
            ',"appName":"' + appText + '"' +
            ',"idAlertConfigMonitoriza":' + alertValue + 
            ',"alertConfigName":"' + alertText + '"}, "length":1}';
            var data = JSON.parse(alertConfigJsonText);
            alertConfigTbl.row.add($(data)).draw(false);
		}
 	});


 
</script>