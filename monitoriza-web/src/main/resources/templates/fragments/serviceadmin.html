<div class="row gap-20 masonry pos-r">
	<div class="masonry-sizer col-md-6"></div>
	<div class="masonry-item col-md-6">
		<div class="bgc-white p-20 bd">
			<h6 class="c-grey-900">Nuevo servicio</h6>
			<div class="mT-30">
				<form id="serviceForm" th:object="${serviceform}" th:action="@{/saveservice}">
					<div class="form-row">
						<div class="form-group col-md-6">
							<label for="name">Nombre</label>
							<input type="text" class="form-control" id="name">
						</div>
						<div class="form-group col-md-6">
							<label for="platform" th:text="#{form.service.platform}"></label>
							<select id="platform" class="form-control" th:field="*{platform}">
								<option selected="selected" value="-1" th:text="#{form.service.select.platform}"></option>
								<option th:each="p: ${platforms}"
										th:value="${p.idPlatform}"
									 	th:text="${p.name}">
								</option>
							</select>
						</div>
					</div>
					<div class="form-row">
						<div id ="serviceTypesContainer" class="form-group col-md-2">
							<label for="serviceTypes" th:text="#{form.service.servicetype}"></label>
							<select id="serviceTypes" class="form-control" th:field="*{serviceType}">
								<option selected="selected" value="-1" th:text="#{form.service.select.servicetype}"></option>
								<option th:each="ts: ${serviceTypes}"
										th:value="${ts}"
									 	th:text="#{ts}">
								</option>
							</select>
						</div>
						<div class="form-group col-md-6">
							<label for="endpoint" th:text="#{form.service.endpoint}"></label>
							<input type="text" class="form-control" id="endpoint" readonly>
						</div>
						<div class="form-group col-md-4">
							<label for="nameWsdl">&nbsp;</label>
							<input type="text" class="form-control" id="nameWsdl" th:field="*{nameWsdl}">
						</div>
					</div>
					<div class="form-row">
						<div class="form-group col-md-6">
							<label for="timeout" th:text="#{form.service.timeout}"></label>
							<input type="time" step="0.001" class="form-control" id="timeout">
						</div>
						<div class="form-group col-md-6">
							<label for="timer" th:text="#{form.service.timer}"></label>
							<select id="timer" class="form-control">
								<option selected="selected">Elija timer...</option>
								<option>...</option>
							</select>
						</div>
					</div>
					<div class="form-row">
						<div class="form-group col-md-6">
							<label for="uDegraded" th:text="#{form.service.udegraded}"></label>
							<input type="time" step="0.001" class="form-control" id="uDegraded">
						</div>
						<div class="form-group col-md-6">
							<label for="uLost" th:text="#{form.service.ulost}"></label>
							<input type="time" step="0.001" class="form-control" id="uLost">
						</div>
					</div>
				</form>
			</div>
		</div>
	</div>
	<div class="masonry-item col-md-6">
		<div class="bgc-white p-20 bd">
			<h6 class="c-grey-900">Nuevo timer</h6>
			<div class="mT-30">
				<form id="timerForm" th:object="${timerform}" th:action="@{/savetimer}" method="post">
					<input type='hidden' class='primarykey' id="idTimer" th:field="*{idTimer}">
					<div class="form-row">
						<div class="form-group col-md-6">
							<label for="name" th:text="#{form.timer.name}"></label>
							<input type="text" class="form-control" id="nameTimer" th:field="*{name}">
						</div>
						<div class="form-group col-md-6">
							<label for="frequency" th:text="#{form.timer.frequency}"></label>
							<input type="text" class="form-control" id="frequency" th:field="*{frequency}">
						</div>
					</div>
					<button id="timerBtn" type="submit" class="btn btn-primary">Guardar</button>
				</form>
			</div>
		</div>
		<!-- <div class="row"> -->
			<!-- <div class="col-md-6"> -->
				<div class="bgc-white bd bdrs-3 p-20 mB-20">
				<h6 class="c-grey-900 mB-20" th:text="#{table.timer.title}"></h6>
				<table id="timerTable" class="table table-striped table-bordered"  
					cellspacing="0" width="100%">
					<thead>
						<tr>
							<!-- Columna oculta para el identificador de la plataforma -->
							<th></th>
							<th th:text="#{table.timer.name}"></th>
							<th th:text="#{table.timer.frequency}"></th>
						</tr>
					</thead>
				</table>
			</div>
			<!-- </div> -->
		<!-- </div> -->
	</div>
</div>
</br>
<div class="container-fluid">
	<div class="row">
		<div class="col-md-12">
			<div class="bgc-white bd bdrs-3 p-20 mB-20">
				<h4 class="c-grey-900 mB-20" th:text="#{table.service.title}"></h4>
				<table id="serviceTable" class="table table-striped table-bordered" 
					cellspacing="0" width="100%">
					<thead>
						<tr>
							<!-- Columna oculta para el identificador de la plataforma -->
							<th></th>
							<th th:text="#{table.service.name}"></th>
							<th th:text="#{table.service.platform}"></th>
							<th th:text="#{table.service.endpoint}"></th>
							<th th:text="#{table.service.timeout}"></th>
							<th th:text="#{table.service.timer}"></th>
							<th th:text="#{table.service.udegraded}"></th>
							<th th:text="#{table.service.ulost}"></th>
						</tr>
					</thead>
				</table>
			</div>
		</div>
	</div>
</div>

<script th:inline="javascript">

$(document).ready(function() {
		
	// Carga los tipos de servicio al seleccionar una plataforma
	var urlLoadServiceTypes = /*[[@{/loadservicetype}]]*/;
	var selectServiceTypeText = /*[[#{form.service.select.servicetype}]]*/;
	$('#platform').change(
	        function() {
	            $.getJSON(urlLoadServiceTypes, {
	            	idPlatform : $(this).val()
	            }, function(data) {
	                var html = '<option value="">' + selectServiceTypeText + '</option>';
	                var len = data.length;
	                for ( var i = 0; i < len; i++) {
	                    html += '<option value="' + data[i] + '">'
	                            + data[i] + '</option>';
	                }
	                html += '</option>';
	                $('#serviceTypes').html(html);
	                $('#endpoint').attr('value', '');
	            });
	        });
	
	// Establece la base del endpoint al seleccionar tipo de servicio (+ plataforma previamente)
	var urlLoadBaseEndpoint = /*[[@{/loadbaseendpoint}]]*/;
	$('#serviceTypes').change(
	        function() {
	            $.getJSON(urlLoadBaseEndpoint, {
	            	idPlatform : $('#platform').val(),
	            	serviceType : $('#serviceTypes').val()
	            }, function(data) {
	               $('#endpoint').attr('value', data.response);
	            });
	        });
	
	// Calcula los tamaños de las zonas de formularios
	if ($('.masonry').length > 0) {
		$('.masonry').masonry({
	    	 itemSelector: '.masonry-item',
		        columnWidth: '.masonry-sizer',
		        percentPosition: true,
	    	});
	}	

	// Gestión de las datatables
	
	var actionSave = /*[[@{/saveafirma}]]*/;
	var actionDelete = /*[[@{/deleteAfirma}]]*/;
	var actionSave = /*[[@{/saveafirma}]]*/;
	var getservices = /*[[@{/servicesdatatable}]]*/;
	var tblService = $('#serviceTable').DataTable({
		dom: 'Bfrtip',
	    select: 'single',
	    responsive: true,
	    
	    altEditor: true,
	    buttons: [{extend: 'selected',text: 'Editar',name: 'editPageForm'}, {extend: 'selected',text: 'Eliminar',name: 'delete'}],
	
	    "iTotalRecords": "totalElements",
        "iTotalDisplayRecords": "numberOfElements",
	    
		"processing": true,
	    "serverSide": true,
		"ajax": {
	        "url": getservices,
	        "dataSrc" : "data",
	        "data": function (data) {
	        	// Datos a pasar al modal
	            data.formId = "serviceForm";
	        }
	      },
	    "language": {
	        "url": "js/datatables/i18n/spanish.json",
	        select: {
	            rows: {
	                _: "%d filas seleccionadas",
	                1: "1 fila seleccionada"
	            }
	          }
	        },
		"columns": [
	        { "data": "idService",
	          "visible": false},
	        { "data": "name" },
	        { "data": "platform.name" },
	        { "data": "timeout" },
	        { "data": "nameWsdl" },
	        { "data": "timer"},
	        { "data": "degradedThreshold"},
	        { "data": "degradedLost"}
	        ]
		}).on('crudaction', function(e, accion, idService, data, rowindex){
		    // e          Evento Jquery
		    // accion     [add|edit|delete]
		    // pkid       Primer campo en la data [id]                ... en add,    retorna null
		    // data       Los campos adicionales  [campo_1, campo_n]  ... en delete, retorna null
		    // rowindex   El index de la fila para el dataTable       ... en add,    retorna null
		    
		    $('#altEditor-modal .modal-body .alert').remove();
		    // Se muestra la capa 'cargando...'
		    loading();
		    
		    switch(accion){
		        case 'add':
		        	if ($('#serviceForm')[0].checkValidity() === false) {
		        		// Se oculta la capa 'cargando...'
		        		hide();
		                event.stopPropagation();
		                
		                $('#serviceForm *').filter(':input').each(function(){
		            	    		            	    
		            	    if(!$(this).checkValidity())
		            	    {
		            	  	 $("#invalid-" + $(this).attr('id')).html();
		            	  	 $("#" + $(this).attr('id')).addClass("is-invalid");
		            	    } else {
		            	  	 $("#" + $(this).attr('id')).removeClass("is-invalid");
		            	    }
		            	    
		            	});
		                
		                // Esto es necesario para forzar que se muestren mensajes de validación de cliente
		                $('<input type="submit">').hide().appendTo($('#serviceForm')).click().remove();
		            } else {
		            	$.ajax(actionSave, {
			            	dataType : 'json',
			            	contentType:'application/json',
			                data : JSON.stringify(data),
			                type:'POST',
			                success: function(data){
			                  
			            		// Se oculta la capa 'cargando...'
			            		hide();
			                    tbl.row.add($(data.data)).draw(false);
			                    		                    
			                    $('#altEditor-modal .modal-body .alert').remove();
			                    $('#altEditor-modal').modal('hide');
			                    		                    
			                },
			                error:function(data){
			                	
			                	// Se oculta la capa 'cargando...'
			                	hide();
			                	// Se eliminan los posibles errores anteriores...
			                	clearValidationResult('afirmaForm');
			                	// Se obtiene el JSON de los campos con errores de validación
			                	// y se modifican los estilos/añaden mensajes
			                	var validation = $(data)["0"].responseJSON;
			                	drawValidationResult(validation.fieldErrors);
			              
			                }
			            });
		            }
		        	$('#afirmaForm').addClass('was-validated');
		            break;
		        case 'edit':
		            $.ajax(actionSave, {
		            	dataType : 'json',
		                contentType:'application/json',
		                data: JSON.stringify(data),
		                type:'POST',
		                success: function(data){
		                   
		                	// Se oculta la capa 'cargando...'
		                	hide();
		                    tbl.row(data.rowindex).data(data.data).draw();
		                    
		                    $('#altEditor-modal .modal-body .alert').remove();
		                    $('#altEditor-modal').modal('hide');
		                },
		                error:function(){}
		            });
		            break;
		        case 'delete':
		            $.ajax(actionDelete,{
		            	data:$.param({'id':idService, 'index':rowindex}),
		                type:'POST',
		                success: function(data){
		                    
		                	// Se oculta la capa 'cargando...'
		                	hide();
		                    tbl.row(data.index).remove().draw();
		                    
		                    $('#altEditor-modal .modal-body .alert').remove();
		                    $('#altEditor-modal').modal('hide');
		                },
		                error:function(){}
		            });
		            break;
		        default:
		            $('#altEditor-modal .modal-body .alert').remove();
		            $('#altEditor-modal .modal-body').append('<div class="alert alert-danger" role="alert"><strong>Acción "'+accion+'" no autorizada!</strong></div>');
		            break;
		    }
		});
	
	var gettimers = /*[[@{/timersdatatable}]]*/;
	var actionDelete = /*[[@{/deleteAfirma}]]*/;
	var tblTimer = $('#timerTable').DataTable({
		dom: 'Bfrtip',
	    select: 'single',
	    responsive: true,
	    
	    altEditor: true,
	    buttons: [{extend: 'selected',text: 'Editar',name: 'editPageForm',
	    			action: function ( e, dt, node, config ) {
	    				// Para el action 'Editar' obtenemos los valores de la fila seleccioanda
	    				// directamente y los copiamos al formulario
	    				for (var o = dt, a = [], e = 0; e < o.context[0].aoColumns.length; e++) a.push({
	    	                id: o.context[0].aoColumns[e].mData,
	    	            	title: o.context[0].aoColumns[e].sTitle                
	    	            });
	    				var d = dt.rows({
	                        selected: !0
	                    })
	                    var idTimer = d.data()[0][a[0].id]
	    				var nameTimer = d.data()[0][a[1].id]
	    				var freqTimer = d.data()[0][a[2].id]
	    				
	    				$("#idTimer").val(idTimer);
	    				$("#nameTimer").val(nameTimer);
	    				$("#frequency").val(freqTimer);
	    				
	    				}
	    		  },
	       		  {extend: 'selected', text: 'Eliminar', name: 'delete',
	    				action: function ( e, dt, node, config ) {	
	    					// Para el action 'Eliminar' obtenemos los valores de la fila seleccioanda
		    				// y mostramos un modal de confirmación antes de ir a servidor para eliminar
	    					for (var o = dt, a = [], e = 0; e < o.context[0].aoColumns.length; e++) a.push({
	    		            	id: o.context[0].aoColumns[e].mData,
	    		                title: o.context[0].aoColumns[e].sTitle
	    		            });
	    		            var d = o.rows({
	    		                    selected: !0
	    		            })
	    		            l = "";
	    		            l += "<form name='altEditor-form' role='form'>", l += "<input type='hidden' class='primarykey' id='" + a[0].id + "' name='" + a[0].title + "' placeholder='" + a[0].title + "' value='" + d.data()[0][a[0].id] + "'>";
	    		            l += "<p>¿Está seguro de que quiere eliminar el timer " + d.data()[0][a[1].id] + "?</p>";
	    		            l += "</form>", t("#altEditor-modal").on("show.bs.modal", function() {
	    		                t("#altEditor-modal").find(".modal-title").html("Eliminar"), t("#altEditor-modal").find(".modal-body").html("<pre class='modal-pre'>" + l + "</pre>"), t("#altEditor-modal").find(".modal-footer").html("<button type='button' data-content='remove' class='btn btn-default' data-dismiss='modal'>Cerrar</button><button type='button' data-content='remove' class='btn btn-danger' id='deleteRowBtn'>Eliminar</button>")
	    		            }), t("#altEditor-modal").modal("show"), t("#altEditor-modal input.primarykey+div input").focus()
	       		  
	       		  		}
	       		  }	
	    		],
	       		  	
	    "iTotalRecords": "totalElements",
        "iTotalDisplayRecords": "numberOfElements",
        "pageLength": 5,
	    
		"processing": true,
	    "serverSide": true,
		"ajax": {
	        "url": gettimers,
	        "dataSrc" : "data",
	        "data": function (data) {
	        	// Datos a pasar al modal
	            data.formId = "timerForm";
	        }
	      },
	    "language": {
	        "url": "js/datatables/i18n/spanish.json",
	        select: {
	            rows: {
	                _: "%d filas seleccionadas",
	                1: "1 fila seleccionada"
	            }
	          }
	        },
		"columns": [
	        { "data": "idTimer",
	          "visible": false},
	        { "data": "name" },
	        { "data": "frequency" }
	        ]
	});
	
	// Control del botón para guardar un timer
	$( "#timerBtn" ).click(function( event ) {
		  event.preventDefault();

		  var formData = JSON.stringify($("#timerForm").serializeJSON());
		  var url = /*[[@{/savetimer}]]*/;
		  
		  loading();
		  
		  $.ajax({
			  type: "POST",
			  url: url,
			  data: formData,
			  success: function(data){
				  
				  $("#timerForm")[0].reset();
				  hide();
				  tblTimer.row.add($(data.data)).draw(false);
				  
			  },
			  dataType: "json",
			  contentType : "application/json"
			});
		});
});	

</script>